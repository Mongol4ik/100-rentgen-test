<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ú–∞–≥–∞–∑–∏–Ω "100 –†–µ–Ω—Ç–≥–µ–Ω"</title>
<style>
  :root{
    --accent:#ff9800;
    --bg:#850000;
    --panel-bg:rgba(18,18,18,0.96);
    --muted:#9aa;
    --card:#101010;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:url('https://i.imgur.com/Z1OWJQa.png') center/cover fixed;color:#fff}
  a{color:inherit}
  button,input,select,textarea{font:inherit}
  button{cursor:pointer}

  header{display:flex;justify-content:space-between;align-items:flex-start;padding:12px 18px;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.2));gap:12px;position:sticky;top:0;z-index:40}
  .brand{display:flex;flex-direction:column}
  .brand h1{margin:0;font-size:18px}
  .controls{display:flex;flex-direction:column;align-items:flex-end;gap:8px}
  .top-buttons{display:flex;gap:8px}

  .categoryFilter{display:flex;gap:8px;align-items:center;overflow:auto;max-width:720px;padding-bottom:6px}
  .categoryFilter button{background:transparent;border:1px solid var(--glass);padding:6px 10px;border-radius:8px;color:#fff}
  .categoryFilter button.active{background:var(--accent);color:#000}

  .subcategoryContainer{margin-top:8px}
  .subcategoryFilter{display:flex;gap:6px;flex-wrap:wrap;max-height:88px;overflow:auto;padding:6px}
  .subcategoryFilter button{background:transparent;border:1px solid var(--glass);padding:6px 8px;border-radius:6px;color:#fff;font-size:13px}
  .subcategoryFilter button.active{background:var(--accent);color:#000}

  .container{padding:18px;display:flex;gap:18px;flex-wrap:wrap;justify-content:flex-start}
  .product-list{display:flex;flex-wrap:wrap;gap:18px}
  .product{width:220px;background:var(--panel-bg);padding:10px;border-radius:10px;border:1px solid var(--glass);cursor:pointer;transition:transform .12s}
  .product:hover{transform:translateY(-6px)}
  .product img{width:100%;height:140px;object-fit:cover;border-radius:6px}
  .product h3{margin:8px 0 4px;font-size:15px}
  .product p{margin:2px 0;color:var(--muted);font-size:13px}

  .panel{position:fixed;right:14px;top:72px;width:520px;max-height:80vh;overflow:auto;background:var(--panel-bg);padding:12px;border-radius:10px;border:1px solid var(--glass);display:none;z-index:60}
  @media(max-width:980px){ .panel{left:14px;right:14px;width:auto} .product{width:calc(50% - 24px)} }

  .list-item{display:flex;justify-content:space-between;gap:8px;padding:8px;border-radius:8px;border:1px solid var(--glass);margin-top:8px;background:linear-gradient(180deg,#0c0c0c,#0a0a0a)}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);display:none;z-index:50}
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b0b0b;padding:16px;border-radius:10px;border:1px solid var(--glass);z-index:60;display:none;max-width:920px;width:92%;max-height:92vh;overflow:auto}
  .modal .close{position:absolute;right:10px;top:8px;background:transparent;border:1px solid var(--glass);color:#fff;padding:6px;border-radius:6px}
  .modal h2{margin:0 0 8px}

  .product-view{
    display:flex;
    gap:24px;
    align-items:flex-start;
    flex-wrap: wrap;
  }
  .product-view-left{
    min-width: 320px;
    flex: 1;
    display: flex;
    justify-content: center;
  }
  .product-view-left img{
    width: 100%;
    max-width: 400px;
    height: 350px;
    object-fit: contain;
    border-radius: 10px;
    background: var(--card);
    padding: 12px;
    border: 1px solid var(--glass);
  }
  .product-view-right{
    flex: 1;
    min-width: 300px;
  }
  .product-view-right h3{
    margin:0 0 12px;
    font-size: 20px;
  }
  .muted{
    color:var(--muted);
    font-size:14px;
  }

  /* –£–í–ï–õ–ò–ß–ï–ù–ù–´–ï –ö–ê–†–¢–ò–ù–ö–ò –î–õ–Ø –û–ë–í–ï–°–û–í */
  .attach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:8px}
  .attach-card{background:#0d0d0d;border:1px solid var(--glass);padding:12px;border-radius:8px;display:flex;flex-direction:column;align-items:center;text-align:center;transition:.12s;cursor:pointer}
  .attach-card img{width:120px;height:120px;object-fit:contain;border-radius:6px;background:var(--card);padding:8px}
  .attach-card .title{margin-top:8px;font-size:14px;font-weight:500}
  .attach-card .price{font-size:14px;color:var(--muted);margin-top:4px}
  .attach-card .row{margin-top:8px;display:flex;align-items:center;gap:6px}
  .attach-card.selected{border:2px solid var(--accent);background:linear-gradient(180deg, rgba(26,18,0,0.15), rgba(0,0,0,0.05))}

  .form-row{display:flex;gap:8px;flex-wrap:wrap}
  .form-col{flex:1;min-width:160px}
  input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #222;background:#080808;color:#fff}
  textarea{min-height:80px}

  .btn{background:var(--accent);color:#000;padding:8px;border-radius:8px;border:none}
  .ghost{background:transparent;border:1px solid var(--glass);color:#fff;padding:6px;border-radius:6px}

  .small-muted{font-size:12px;color:var(--muted);margin-top:6px}
  .attach-row{display:flex;gap:8px;align-items:center;margin-top:8px}
  .attach-row input[type="text"], .attach-row input[type="number"], .attach-row select{padding:6px;border-radius:6px;background:#080808;border:1px solid #222;color:#fff}
  .msg-box{margin-top:8px;display:flex;gap:8px}
  .chat-note{margin-top:6px;font-size:13px;color:#ffdca8;background:rgba(255,220,168,0.1);padding:8px;border-radius:6px;border-left:3px solid #ffdca8}

  /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–∫–∞–∑–∞ */
  .order-details{margin-top:8px;padding:8px;background:rgba(255,255,255,0.05);border-radius:6px}
  .order-item{margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.1)}
  .order-item:last-child{border-bottom:none;margin-bottom:0}
  .item-name{font-weight:500}
  .item-attachments{margin-left:12px;font-size:12px;color:var(--muted)}
  .item-qty{color:var(--accent);margin-left:4px}

  /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
  .message-notification{background:rgba(255,152,0,0.2);border:1px solid var(--accent);padding:8px;border-radius:6px;margin-top:6px}

  /* –ó–∞–≥—Ä—É–∑–∫–∞ */
  .loading{opacity:0.7;pointer-events:none}

  /* –°–¢–ò–õ–ò –î–õ–Ø –°–¢–ê–í–û–ö */
  .bets-section {
    margin-top: 20px;
    padding: 15px;
    background: var(--panel-bg);
    border-radius: 10px;
    border: 1px solid var(--glass);
  }

  .bracket {
    display: flex;
    justify-content: space-between;
    margin: 20px 0;
    overflow-x: auto;
  }

  .round {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    min-width: 200px;
  }

  .match {
    background: var(--card);
    border: 1px solid var(--glass);
    border-radius: 8px;
    padding: 10px;
    margin: 10px 0;
    min-height: 80px;
  }

  .participant {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px;
    margin: 2px 0;
    border-radius: 4px;
    cursor: pointer;
  }

  .participant:hover {
    background: rgba(255,152,0,0.1);
  }

  .participant.selected {
    background: rgba(255,152,0,0.2);
    border: 1px solid var(--accent);
  }

  .coefficient {
    background: var(--accent);
    color: #000;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    font-size: 12px;
  }

  .bet-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  .bet-amount {
    width: 80px;
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #222;
    background: #080808;
    color: #fff;
  }

  .bet-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-left: 8px;
  }

  .bet-won {
    background: #4CAF50;
    color: white;
  }

  .bet-lost {
    background: #f44336;
    color: white;
  }

  .bet-pending {
    background: #FF9800;
    color: black;
  }

  .players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin: 10px 0;
  }

  .player-card {
    background: var(--card);
    border: 1px solid var(--glass);
    border-radius: 6px;
    padding: 8px;
    text-align: center;
    cursor: pointer;
  }

  .player-card.selected {
    border-color: var(--accent);
    background: rgba(255,152,0,0.1);
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <h1>100 –†–µ–Ω—Ç–≥–µ–Ω</h1>
    <div class="muted">–ü—Ä–æ–¥–∞–µ–º –ª—é–¥–µ–π, –±–∞–Ω–∞–Ω—ã. –®—É—Ç–∏–º –Ω–µ –±–∞–Ω–∞–Ω—ã</div>
  </div>

  <div class="controls">
    <div class="top-buttons">
      <button id="btnCart" class="ghost">–ö–æ—Ä–∑–∏–Ω–∞</button>
      <button id="btnBets" class="ghost">–°—Ç–∞–≤–∫–∏</button>
      <button id="btnLogin" class="ghost">–í—Ö–æ–¥</button>
      <button id="btnMyOrders" class="ghost" style="display:none">–ú–æ–∏ –∑–∞—è–≤–∫–∏</button>
      <button id="btnSeller" class="ghost">–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</button>
    </div>

    <div class="categoryFilter" id="categoryFilter"></div>
    <div class="subcategoryContainer" id="subcategoryContainer"></div>
  </div>
</header>

<main class="container">
  <div id="productList" class="product-list"></div>
</main>

<div id="overlay" class="overlay"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞–≤–æ–∫ -->
<div id="betsPanel" class="panel">
  <h3>‚ö° –¢—É—Ä–Ω–∏—Ä—ã –∏ –°—Ç–∞–≤–∫–∏</h3>
  
  <div id="betsTabs" style="display:flex;gap:8px;margin-bottom:12px">
    <button id="tabActiveBets" class="ghost active">–ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏</button>
    <button id="tabMyBets" class="ghost">–ú–æ–∏ —Å—Ç–∞–≤–∫–∏</button>
    <button id="tabTournament" class="ghost">–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞</button>
    <button id="tabPlayers" class="ghost">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
  </div>

  <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ -->
  <div id="activeBetsSection">
    <div id="activeBetsList"></div>
  </div>

  <!-- –ú–æ–∏ —Å—Ç–∞–≤–∫–∏ -->
  <div id="myBetsSection" style="display:none">
    <div id="myBetsList"></div>
  </div>

  <!-- –¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ -->
  <div id="tournamentSection" style="display:none">
    <div id="tournamentBracket"></div>
    <div style="margin-top:12px">
      <button id="btnCreateMatch" class="btn">–°–æ–∑–¥–∞—Ç—å –º–∞—Ç—á</button>
      <button id="btnGenerateBracket" class="btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É</button>
    </div>
  </div>

  <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
  <div id="playersSection" style="display:none">
    <div style="margin-bottom:12px">
      <strong>–î–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è –≤ —Ç—É—Ä–Ω–∏—Ä:</strong>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="playerNickname" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º" />
        <button id="btnAddPlayer" class="btn">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</button>
      </div>
    </div>
    <div id="playersList"></div>
  </div>

  <div style="margin-top:12px">
    <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<div id="productModalView" class="modal" aria-hidden="true">
  <button class="close" id="closeProductView">‚úï</button>
  <div id="productViewContent"></div>
</div>

<div id="productModalEdit" class="modal" aria-hidden="true">
  <button class="close" id="closeProductEdit">‚úï</button>
  <h2 id="editTitle">–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
  <div id="productEditForm"></div>
</div>

<div id="cartPanel" class="panel">
  <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
  <div id="cartItems"></div>
  <p>–ò—Ç–æ–≥–æ: <b id="cartTotal">0</b> üí∞</p>
  <div style="display:flex;gap:8px;justify-content:flex-end">
    <button id="btnCheckout" class="btn">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="loginPanel" class="panel">
  <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
  <input id="username" placeholder="–ò–º—è" />
  <input id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
  <div style="display:flex;gap:8px;margin-top:8px">
    <button id="btnRegister" class="btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button id="btnSignIn" class="btn">–í–æ–π—Ç–∏</button>
    <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="myOrdersPanel" class="panel">
  <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
  <div id="myOrdersList"></div>
  <div style="margin-top:12px">
    <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="sellerPanel" class="panel">
  <h3>–ü–∞–Ω–µ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞</h3>
  <div id="sellerLoginArea">
    <input id="sellerPass" placeholder="–ü–∞—Ä–æ–ª—å –ø—Ä–æ–¥–∞–≤—Ü–∞" type="password" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btnSellerLogin" class="btn">–í–æ–π—Ç–∏</button>
      <button class="ghost" onclick="closeAllPanels()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="sellerArea" style="display:none;margin-top:12px">
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="tabOrders" class="ghost active">–ó–∞—è–≤–∫–∏</button>
      <button id="tabProducts" class="ghost">–¢–æ–≤–∞—Ä—ã</button>
      <button id="tabCategories" class="ghost">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button id="tabBetsAdmin" class="ghost">–°—Ç–∞–≤–∫–∏ (–∞–¥–º–∏–Ω)</button>
      <button class="ghost" onclick="closeAllPanels()" style="margin-left:auto">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="sellerOrdersSection">
      <div id="ordersList"></div>
    </div>

    <div id="sellerProductsSection" style="display:none">
      <div id="productsEditorList"></div>
      <div style="margin-top:12px">
        <button id="btnNewProduct" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      </div>
    </div>

    <div id="sellerCategoriesSection" style="display:none">
      <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
    </div>

    <!-- –ê–¥–º–∏–Ω–∫–∞ —Å—Ç–∞–≤–æ–∫ -->
    <div id="sellerBetsSection" style="display:none">
      <h4>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∞–º–∏</h4>
      
      <div style="margin-bottom:12px">
        <strong>–°–æ–∑–¥–∞—Ç—å –º–∞—Ç—á:</strong>
        <div class="form-row" style="margin-top:8px">
          <input id="matchPlayer1" placeholder="–ò–≥—Ä–æ–∫ 1" />
          <input id="matchPlayer2" placeholder="–ò–≥—Ä–æ–∫ 2" />
          <input id="matchCoefficient1" type="number" placeholder="–ö—Ñ. 1" step="0.1" />
          <input id="matchCoefficient2" type="number" placeholder="–ö—Ñ. 2" step="0.1" />
          <button id="btnCreateAdminMatch" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <strong>–ê–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Ç—á–∏:</strong>
        <div id="adminMatchesList"></div>
      </div>

      <div style="margin-top:12px">
        <strong>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏:</strong>
        <div id="adminResultsList"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* -------------------------
   JSONBin Configuration
   ------------------------- */
const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3/b';
const JSONBIN_MASTER_KEY = '$2a$10$wTicXNpl/tYWk2p1tuUuC.w87l4en0x8a9e7STVUKFIfFQnaZFdLC';
const JSONBIN_ACCESS_KEY = '$2a$10$.twuYFU3QYQ1ZXPY.uyfB.7EryqBOUndWb3UbhjCfknwxJvHKo2LG';

const JSONBIN_IDS = {
  PRODUCTS: '6904f4cbae596e708f3ab82d',      
  USERS: '6904f5d843b1c97be98eff3a',           
  CATS: '6904f52243b1c97be98efe37',           
  CHATS: '6904f602ae596e708f3aba24',           
  CONFIG: '69050c5343b1c97be98f23c9',
  BETS: '690f1c1cae596e708f4c2532' // –ù–æ–≤—ã–π bin –¥–ª—è —Å—Ç–∞–≤–æ–∫
};

/* -------------------------
   Storage & defaults
   ------------------------- */
const KEY_PRODUCTS = 'products_v_final_v1';
const KEY_USERS = 'users_v_final_v1';
const KEY_CATS = 'cats_v_final_v1';
const KEY_CHATS = 'chats_v1';
const KEY_CURRENT_USER = 'currentUser';
const KEY_SELLER_CONFIG = 'sellerConfig';
const KEY_BETS = 'bets_v1'; // –ù–æ–≤—ã–π –∫–ª—é—á –¥–ª—è —Å—Ç–∞–≤–æ–∫

// –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Å—Ç–∞–≤–æ–∫
const DEFAULT_BETS_DATA = {
  players: [], // –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  matches: [], // –ê–∫—Ç–∏–≤–Ω—ã–µ –º–∞—Ç—á–∏
  tournaments: [], // –¢—É—Ä–Ω–∏—Ä–Ω—ã–µ —Å–µ—Ç–∫–∏
  bets: [], // –í—Å–µ —Å–¥–µ–ª–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
  coefficients: {} // –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è –º–∞—Ç—á–µ–π
};

let betsData = JSON.parse(JSON.stringify(DEFAULT_BETS_DATA));

/* -------------------------
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫
   ------------------------- */
async function initializeBetsData() {
  try {
    betsData = await loadJSON(KEY_BETS, DEFAULT_BETS_DATA);
  } catch (error) {
    console.error('Bets data initialization failed:', error);
    betsData = JSON.parse(JSON.stringify(DEFAULT_BETS_DATA));
  }
}

/* -------------------------
   –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞–≤–∫–∞–º–∏
   ------------------------- */

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ —Ç—É—Ä–Ω–∏—Ä
async function addPlayer(nickname) {
  if (!nickname.trim()) return false;
  
  const player = {
    id: Date.now(),
    nickname: nickname.trim(),
    joined: new Date().toLocaleString(),
    wins: 0,
    losses: 0
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ –∏–≥—Ä–æ–∫–∞
  if (betsData.players.find(p => p.nickname.toLowerCase() === player.nickname.toLowerCase())) {
    alert('–ò–≥—Ä–æ–∫ —Å —Ç–∞–∫–∏–º –Ω–∏–∫–æ–º —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç!');
    return false;
  }
  
  betsData.players.push(player);
  const saved = await saveJSON(KEY_BETS, betsData);
  if (saved) {
    renderPlayersList();
    return true;
  }
  return false;
}

// –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞
async function createMatch(player1, player2, coeff1 = 1.5, coeff2 = 1.5) {
  const match = {
    id: Date.now(),
    player1: player1.trim(),
    player2: player2.trim(),
    coefficient1: parseFloat(coeff1) || 1.5,
    coefficient2: parseFloat(coeff2) || 1.5,
    status: 'active', // active, finished, cancelled
    winner: null,
    date: new Date().toLocaleString()
  };
  
  betsData.matches.push(match);
  const saved = await saveJSON(KEY_BETS, betsData);
  if (saved) {
    renderActiveBets();
    renderAdminMatches();
    return true;
  }
  return false;
}

// –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
async function placeBet(matchId, selectedPlayer, amount, betOnPlayer1) {
  if (!currentUser) {
    alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∏!');
    return false;
  }
  
  if (!amount || amount <= 0) {
    alert('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏!');
    return false;
  }
  
  const match = betsData.matches.find(m => m.id === matchId);
  if (!match || match.status !== 'active') {
    alert('–ú–∞—Ç—á –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω!');
    return false;
  }
  
  const bet = {
    id: Date.now(),
    matchId: matchId,
    userId: currentUser,
    betOnPlayer1: betOnPlayer1,
    selectedPlayer: selectedPlayer,
    amount: parseFloat(amount),
    coefficient: betOnPlayer1 ? match.coefficient1 : match.coefficient2,
    potentialWin: parseFloat(amount) * (betOnPlayer1 ? match.coefficient1 : match.coefficient2),
    status: 'pending', // pending, won, lost
    date: new Date().toLocaleString()
  };
  
  betsData.bets.push(bet);
  const saved = await saveJSON(KEY_BETS, betsData);
  if (saved) {
    renderActiveBets();
    renderMyBets();
    alert(`–°—Ç–∞–≤–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∞! –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: ${bet.potentialWin.toFixed(2)} üí∞`);
    return true;
  }
  return false;
}

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –º–∞—Ç—á–∞
async function setMatchResult(matchId, winner) {
  const match = betsData.matches.find(m => m.id === matchId);
  if (!match) return false;
  
  match.status = 'finished';
  match.winner = winner;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–≥—Ä–æ–∫–æ–≤
  if (winner === match.player1) {
    updatePlayerStats(match.player1, 'win');
    updatePlayerStats(match.player2, 'loss');
  } else {
    updatePlayerStats(match.player1, 'loss');
    updatePlayerStats(match.player2, 'win');
  }
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã —Å—Ç–∞–≤–æ–∫
  betsData.bets.forEach(bet => {
    if (bet.matchId === matchId) {
      if ((bet.betOnPlayer1 && winner === match.player1) || 
          (!bet.betOnPlayer1 && winner === match.player2)) {
        bet.status = 'won';
      } else {
        bet.status = 'lost';
      }
    }
  });
  
  const saved = await saveJSON(KEY_BETS, betsData);
  if (saved) {
    renderActiveBets();
    renderMyBets();
    renderAdminMatches();
    return true;
  }
  return false;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞
function updatePlayerStats(playerNickname, result) {
  const player = betsData.players.find(p => p.nickname === playerNickname);
  if (player) {
    if (result === 'win') {
      player.wins = (player.wins || 0) + 1;
    } else {
      player.losses = (player.losses || 0) + 1;
    }
  }
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–∏
async function generateTournamentBracket() {
  if (betsData.players.length < 2) {
    alert('–ù—É–∂–Ω–æ –∫–∞–∫ –º–∏–Ω–∏–º—É–º 2 –∏–≥—Ä–æ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ç–∫–∏!');
    return;
  }
  
  // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - —Å–æ–∑–¥–∞–µ–º –º–∞—Ç—á–∏ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏
  const shuffledPlayers = [...betsData.players].sort(() => Math.random() - 0.5);
  const newMatches = [];
  
  for (let i = 0; i < shuffledPlayers.length - 1; i += 2) {
    if (i + 1 < shuffledPlayers.length) {
      const match = {
        id: Date.now() + i,
        player1: shuffledPlayers[i].nickname,
        player2: shuffledPlayers[i + 1].nickname,
        coefficient1: (Math.random() * 2 + 1).toFixed(2),
        coefficient2: (Math.random() * 2 + 1).toFixed(2),
        status: 'active',
        winner: null,
        date: new Date().toLocaleString(),
        round: 1
      };
      newMatches.push(match);
    }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –º–∞—Ç—á–∏
  newMatches.forEach(match => {
    if (!betsData.matches.find(m => m.player1 === match.player1 && m.player2 === match.player2)) {
      betsData.matches.push(match);
    }
  });
  
  const saved = await saveJSON(KEY_BETS, betsData);
  if (saved) {
    renderTournamentBracket();
    renderActiveBets();
    alert('–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!');
  }
}

/* -------------------------
   –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ UI –¥–ª—è —Å—Ç–∞–≤–æ–∫
   ------------------------- */

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
function renderPlayersList() {
  const list = document.getElementById('playersList');
  if (!list) return;
  
  if (betsData.players.length === 0) {
    list.innerHTML = '<div class="muted">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    return;
  }
  
  list.innerHTML = `
    <div class="players-grid">
      ${betsData.players.map(player => `
        <div class="player-card">
          <div><strong>${escapeHtml(player.nickname)}</strong></div>
          <div class="muted">–ü–æ–±–µ–¥—ã: ${player.wins || 0} | –ü–æ—Ä–∞–∂–µ–Ω–∏—è: ${player.losses || 0}</div>
        </div>
      `).join('')}
    </div>
  `;
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞–≤–æ–∫
function renderActiveBets() {
  const list = document.getElementById('activeBetsList');
  if (!list) return;
  
  const activeMatches = betsData.matches.filter(m => m.status === 'active');
  
  if (activeMatches.length === 0) {
    list.innerHTML = '<div class="muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π –Ω–µ—Ç</div>';
    return;
  }
  
  list.innerHTML = activeMatches.map(match => `
    <div class="match">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>–ú–∞—Ç—á #${match.id}</strong>
        <span class="muted">${match.date}</span>
      </div>
      
      <div class="participant" onclick="selectParticipant(this, ${match.id}, true)">
        <span>${escapeHtml(match.player1)}</span>
        <span class="coefficient">${match.coefficient1}x</span>
      </div>
      
      <div style="text-align:center;margin:5px 0">VS</div>
      
      <div class="participant" onclick="selectParticipant(this, ${match.id}, false)">
        <span>${escapeHtml(match.player2)}</span>
        <span class="coefficient">${match.coefficient2}x</span>
      </div>
      
      <div class="bet-controls" id="betControls_${match.id}" style="display:none">
        <input type="number" class="bet-amount" id="betAmount_${match.id}" placeholder="–°—É–º–º–∞" min="1">
        <button class="btn" onclick="placeSelectedBet(${match.id})">–°–¥–µ–ª–∞—Ç—å —Å—Ç–∞–≤–∫—É</button>
      </div>
    </div>
  `).join('');
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–æ–∏—Ö —Å—Ç–∞–≤–æ–∫
function renderMyBets() {
  const list = document.getElementById('myBetsList');
  if (!list) return;
  
  if (!currentUser) {
    list.innerHTML = '<div class="muted">–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞–≤–æ–∫</div>';
    return;
  }
  
  const myBets = betsData.bets.filter(bet => bet.userId === currentUser);
  
  if (myBets.length === 0) {
    list.innerHTML = '<div class="muted">–£ –≤–∞—Å –Ω–µ—Ç —Å—Ç–∞–≤–æ–∫</div>';
    return;
  }
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
  myBets.sort((a, b) => b.id - a.id);
  
  list.innerHTML = myBets.map(bet => {
    const match = betsData.matches.find(m => m.id === bet.matchId);
    if (!match) return '';
    
    const statusClass = 
      bet.status === 'won' ? 'bet-won' :
      bet.status === 'lost' ? 'bet-lost' : 'bet-pending';
    
    const statusText = 
      bet.status === 'won' ? '–í—ã–∏–≥—Ä–∞–Ω–∞' :
      bet.status === 'lost' ? '–ü—Ä–æ–∏–≥—Ä–∞–Ω–∞' : '–í –ø—Ä–æ—Ü–µ—Å—Å–µ';
    
    return `
      <div class="list-item">
        <div style="flex:1">
          <div><strong>${escapeHtml(match.player1)} vs ${escapeHtml(match.player2)}</strong></div>
          <div class="muted">–°—Ç–∞–≤–∫–∞ –Ω–∞: ${escapeHtml(bet.selectedPlayer)}</div>
          <div>–°—É–º–º–∞: ${bet.amount} üí∞ √ó ${bet.coefficient}x = ${bet.potentialWin.toFixed(2)} üí∞</div>
          <div class="muted">${bet.date}</div>
        </div>
        <div>
          <span class="bet-status ${statusClass}">${statusText}</span>
        </div>
      </div>
    `;
  }).join('');
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Å–µ—Ç–∫–∏
function renderTournamentBracket() {
  const bracket = document.getElementById('tournamentBracket');
  if (!bracket) return;
  
  const activeMatches = betsData.matches.filter(m => m.status === 'active');
  
  if (activeMatches.length === 0) {
    bracket.innerHTML = '<div class="muted">–¢—É—Ä–Ω–∏—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ –ø—É—Å—Ç–∞</div>';
    return;
  }
  
  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –º–∞—Ç—á–∏ –ø–æ —Ä–∞—É–Ω–¥–∞–º
  const rounds = {};
  activeMatches.forEach(match => {
    const round = match.round || 1;
    if (!rounds[round]) rounds[round] = [];
    rounds[round].push(match);
  });
  
  bracket.innerHTML = `
    <div class="bracket">
      ${Object.keys(rounds).map(round => `
        <div class="round">
          <h4>–†–∞—É–Ω–¥ ${round}</h4>
          ${rounds[round].map(match => `
            <div class="match">
              <div class="participant ${match.winner === match.player1 ? 'selected' : ''}">
                ${escapeHtml(match.player1)}
                <span class="coefficient">${match.coefficient1}x</span>
              </div>
              <div style="text-align:center;margin:2px 0">VS</div>
              <div class="participant ${match.winner === match.player2 ? 'selected' : ''}">
                ${escapeHtml(match.player2)}
                <span class="coefficient">${match.coefficient2}x</span>
              </div>
            </div>
          `).join('')}
        </div>
      `).join('')}
    </div>
  `;
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∞–¥–º–∏–Ω–∫–∏ —Å—Ç–∞–≤–æ–∫
function renderAdminMatches() {
  const list = document.getElementById('adminMatchesList');
  const resultsList = document.getElementById('adminResultsList');
  if (!list || !resultsList) return;
  
  const activeMatches = betsData.matches.filter(m => m.status === 'active');
  const finishedMatches = betsData.matches.filter(m => m.status === 'finished');
  
  list.innerHTML = activeMatches.length === 0 ? 
    '<div class="muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö –º–∞—Ç—á–µ–π –Ω–µ—Ç</div>' :
    activeMatches.map(match => `
      <div class="list-item">
        <div style="flex:1">
          <strong>${escapeHtml(match.player1)}</strong> (${match.coefficient1}x) 
          vs 
          <strong>${escapeHtml(match.player2)}</strong> (${match.coefficient2}x)
          <div class="muted">${match.date}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn" onclick="setMatchResult(${match.id}, '${match.player1}')">–ü1</button>
          <button class="ghost" onclick="setMatchResult(${match.id}, '${match.player2}')">–ü2</button>
          <button class="ghost" onclick="deleteMatch(${match.id})">‚ùå</button>
        </div>
      </div>
    `).join('');
  
  resultsList.innerHTML = finishedMatches.length === 0 ? 
    '<div class="muted">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –º–∞—Ç—á–µ–π –Ω–µ—Ç</div>' :
    finishedMatches.map(match => `
      <div class="list-item">
        <div style="flex:1">
          <strong>${escapeHtml(match.player1)}</strong> vs <strong>${escapeHtml(match.player2)}</strong>
          <div class="muted">–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ${escapeHtml(match.winner)}</div>
          <div class="muted">${match.date}</div>
        </div>
      </div>
    `).join('');
}

/* -------------------------
   –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–≤–æ–∫
   ------------------------- */

let selectedMatchId = null;
let selectedBetOnPlayer1 = null;

function selectParticipant(element, matchId, betOnPlayer1) {
  // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ —ç—Ç–æ–º –º–∞—Ç—á–µ
  const matchElement = element.closest('.match');
  matchElement.querySelectorAll('.participant').forEach(p => {
    p.classList.remove('selected');
  });
  
  // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
  element.classList.add('selected');
  
  selectedMatchId = matchId;
  selectedBetOnPlayer1 = betOnPlayer1;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º controls –¥–ª—è —Å—Ç–∞–≤–∫–∏
  const controls = document.getElementById(`betControls_${matchId}`);
  if (controls) {
    controls.style.display = 'flex';
  }
}

async function placeSelectedBet(matchId) {
  const amountInput = document.getElementById(`betAmount_${matchId}`);
  const amount = parseFloat(amountInput?.value);
  
  if (!amount || amount <= 0) {
    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É —Å—Ç–∞–≤–∫–∏!');
    return;
  }
  
  const match = betsData.matches.find(m => m.id === matchId);
  if (!match) return;
  
  const selectedPlayer = selectedBetOnPlayer1 ? match.player1 : match.player2;
  
  await placeBet(matchId, selectedPlayer, amount, selectedBetOnPlayer1);
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
  const controls = document.getElementById(`betControls_${matchId}`);
  if (controls) {
    controls.style.display = 'none';
  }
  selectedMatchId = null;
  selectedBetOnPlayer1 = null;
}

async function deleteMatch(matchId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –º–∞—Ç—á?')) return;
  
  betsData.matches = betsData.matches.filter(m => m.id !== matchId);
  // –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–∫–∏
  betsData.bets = betsData.bets.filter(b => b.matchId !== matchId);
  
  const saved = await saveJSON(KEY_BETS, betsData);
  if (saved) {
    renderActiveBets();
    renderTournamentBracket();
    renderAdminMatches();
  }
}

/* -------------------------
   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ —Å—Ç–∞–≤–æ–∫
   ------------------------- */

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞–≤–æ–∫
document.getElementById('btnBets').addEventListener('click', (e) => {
  e.stopPropagation();
  togglePanel('betsPanel');
  showBetsTab('active');
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∫–ª–∞–¥–æ–∫ —Å—Ç–∞–≤–æ–∫
document.getElementById('tabActiveBets').addEventListener('click', () => showBetsTab('active'));
document.getElementById('tabMyBets').addEventListener('click', () => showBetsTab('my'));
document.getElementById('tabTournament').addEventListener('click', () => showBetsTab('tournament'));
document.getElementById('tabPlayers').addEventListener('click', () => showBetsTab('players'));

function showBetsTab(tabName) {
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏
  ['activeBetsSection', 'myBetsSection', 'tournamentSection', 'playersSection'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  
  // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
  ['tabActiveBets', 'tabMyBets', 'tabTournament', 'tabPlayers'].forEach(id => {
    const btn = document.getElementById(id);
    if (btn) btn.classList.remove('active');
  });
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
  switch(tabName) {
    case 'active':
      document.getElementById('activeBetsSection').style.display = 'block';
      document.getElementById('tabActiveBets').classList.add('active');
      renderActiveBets();
      break;
    case 'my':
      document.getElementById('myBetsSection').style.display = 'block';
      document.getElementById('tabMyBets').classList.add('active');
      renderMyBets();
      break;
    case 'tournament':
      document.getElementById('tournamentSection').style.display = 'block';
      document.getElementById('tabTournament').classList.add('active');
      renderTournamentBracket();
      break;
    case 'players':
      document.getElementById('playersSection').style.display = 'block';
      document.getElementById('tabPlayers').classList.add('active');
      renderPlayersList();
      break;
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –≤ —Å—Ç–∞–≤–∫–∞—Ö
document.getElementById('btnAddPlayer').addEventListener('click', async () => {
  const nickname = document.getElementById('playerNickname').value.trim();
  if (nickname) {
    const success = await addPlayer(nickname);
    if (success) {
      document.getElementById('playerNickname').value = '';
    }
  }
});

document.getElementById('btnGenerateBracket').addEventListener('click', generateTournamentBracket);
document.getElementById('btnCreateMatch').addEventListener('click', () => {
  const player1 = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞:');
  const player2 = prompt('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞:');
  if (player1 && player2) {
    createMatch(player1, player2);
  }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ —Å—Ç–∞–≤–æ–∫
document.getElementById('btnCreateAdminMatch').addEventListener('click', async () => {
  const player1 = document.getElementById('matchPlayer1').value.trim();
  const player2 = document.getElementById('matchPlayer2').value.trim();
  const coeff1 = document.getElementById('matchCoefficient1').value;
  const coeff2 = document.getElementById('matchCoefficient2').value;
  
  if (player1 && player2) {
    const success = await createMatch(player1, player2, coeff1, coeff2);
    if (success) {
      document.getElementById('matchPlayer1').value = '';
      document.getElementById('matchPlayer2').value = '';
      document.getElementById('matchCoefficient1').value = '';
      document.getElementById('matchCoefficient2').value = '';
    }
  }
});

// –î–æ–±–∞–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É —Å—Ç–∞–≤–æ–∫ –≤ –∞–¥–º–∏–Ω–∫—É
document.getElementById('tabBetsAdmin').addEventListener('click', () => { 
  showSellerTab('bets'); 
  renderAdminMatches(); 
});

/* -------------------------
   –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
   ------------------------- */

// –î–æ–±–∞–≤–ª—è–µ–º KEY_BETS –≤ —Ñ—É–Ω–∫—Ü–∏—é loadJSON
async function loadJSON(key, fallback) {
  try {
    let binId;
    switch(key) {
      case KEY_PRODUCTS: binId = JSONBIN_IDS.PRODUCTS; break;
      case KEY_USERS: binId = JSONBIN_IDS.USERS; break;
      case KEY_CATS: binId = JSONBIN_IDS.CATS; break;
      case KEY_CHATS: binId = JSONBIN_IDS.CHATS; break;
      case KEY_SELLER_CONFIG: binId = JSONBIN_IDS.CONFIG; break;
      case KEY_BETS: binId = JSONBIN_IDS.BETS; break; // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–≤–∫–∏
      default: return JSON.parse(JSON.stringify(fallback));
    }
    
    const data = await jsonbinFetch(binId);
    return data || JSON.parse(JSON.stringify(fallback));
  } catch(e) {
    console.error('Load error:', e);
    return JSON.parse(JSON.stringify(fallback));
  }
}

// –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è saveJSON
async function saveJSON(key, val) {
  try {
    let binId;
    switch(key) {
      case KEY_PRODUCTS: binId = JSONBIN_IDS.PRODUCTS; break;
      case KEY_USERS: binId = JSONBIN_IDS.USERS; break;
      case KEY_CATS: binId = JSONBIN_IDS.CATS; break;
      case KEY_CHATS: binId = JSONBIN_IDS.CHATS; break;
      case KEY_SELLER_CONFIG: binId = JSONBIN_IDS.CONFIG; break;
      case KEY_BETS: binId = JSONBIN_IDS.BETS; break; // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–≤–∫–∏
      default: return;
    }
    
    await jsonbinUpdate(binId, val);
    return true;
  } catch(e) {
    console.error('Save error:', e);
    return false;
  }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö
async function initializeData() {
  if (isLoading) return;
  isLoading = true;
  
  try {
    document.body.classList.add('loading');
    
    const [productsData, usersData, catsData, configData, betsDataLoaded] = await Promise.all([
      loadJSON(KEY_PRODUCTS, DEFAULT_PRODUCTS),
      loadJSON(KEY_USERS, {}),
      loadJSON(KEY_CATS, DEFAULT_CATS),
      loadJSON(KEY_SELLER_CONFIG, DEFAULT_CONFIG),
      loadJSON(KEY_BETS, DEFAULT_BETS_DATA) // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–æ–∫
    ]);
    
    products = productsData;
    users = usersData;
    cats = catsData;
    sellerConfig = configData;
    betsData = betsDataLoaded;
    
    console.log('Data loaded:', { products, users, cats, sellerConfig, betsData });
  } catch (error) {
    console.error('Data initialization failed:', error);
    // Fallback to defaults
    products = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS));
    users = {};
    cats = JSON.parse(JSON.stringify(DEFAULT_CATS));
    sellerConfig = DEFAULT_CONFIG;
    betsData = JSON.parse(JSON.stringify(DEFAULT_BETS_DATA));
  } finally {
    document.body.classList.remove('loading');
    isLoading = false;
  }
}

// –î–æ–±–∞–≤–ª—è–µ–º betsPanel –≤ closeAllPanels
function closeAllPanels(){
  ['cartPanel','betsPanel','loginPanel','myOrdersPanel','sellerPanel'].forEach(id => {
    const panel = el(id);
    if(panel) panel.style.display = 'none';
  });
  
  ['productModalView','productModalEdit'].forEach(id => {
    const modal = el(id);
    if(modal) modal.style.display = 'none';
  });
  
  const overlay = document.getElementById('overlay');
  if(overlay) overlay.style.display = 'none';
  
  document.querySelectorAll('.modal').forEach(modal => {
    if(!modal.id) modal.remove();
  });
}

// –û–±–Ω–æ–≤–ª—è–µ–º showSellerTab –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞–≤–æ–∫
function showSellerTab(name){
  el('sellerOrdersSection').style.display = name==='orders' ? 'block' : 'none';
  el('sellerProductsSection').style.display = name==='products' ? 'block' : 'none';
  el('sellerCategoriesSection').style.display = name==='categories' ? 'block' : 'none';
  el('sellerBetsSection').style.display = name==='bets' ? 'block' : 'none';
  
  ['tabOrders','tabProducts','tabCategories','tabBetsAdmin'].forEach(tab => {
    el(tab).classList.remove('active');
  });
  el('tab' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
async function initialRender(){
  await initializeData();
  await initializeBetsData(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–≤–æ–∫
  renderCategoryFilter(); 
  renderSubcats(null); 
  renderProducts(); 
  updateUserUI();
  
  closeAllPanels();
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
initialRender();

/* Debug helpers */
window._debug = {
  products: () => products,
  users: () => users,
  cats: () => cats,
  currentUser: () => currentUser,
  sellerConfig: () => sellerConfig,
  betsData: () => betsData, // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–≤–∫–∏ –≤ debug
  closeAll: closeAllPanels
};

// –û—Å—Ç–∞–ª—å–Ω–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π...
</script>
</body>
</html>